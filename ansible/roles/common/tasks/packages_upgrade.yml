- name: Upgrade packages to their latest version if configured
  package:
    name: "*"
    state: latest
  register: result
  retries: 5
  delay: 5
  until: result is success
  when: system_packages_upgrade | bool

- name: Remove packages that are no longer required if configured
  package:
    autoremove: true
  when: system_packages_autoremove | bool

- name: Run Automatic Security Upgrades directly (Ubuntu)
  command: unattended-upgrade
  register: result
  retries: 5
  delay: 5
  until: result is success
  when:
    - system_packages_auto_security_upgrade
    - ansible_facts['os_family'] == "Debian"

- name: Run Automatic Security Upgrades directly (RHEL)
  command: dnf-automatic
  register: result
  retries: 5
  delay: 5
  until: result is success
  when:
    - system_packages_auto_security_upgrade
    - ansible_facts['os_family'] == "RedHat"
